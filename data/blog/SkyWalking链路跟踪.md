---
title: SkyWalking：应用监控和链路跟踪
date: 2023/8/5 09:00:00
lastmod: 2023/8/10 09:00:00
tags: [SkyWalking, Java, 监控]
draft: false
summary: 在本文中，我将学习如果对微服务进行链路追踪
images: '/static/images/skywalking/logo.svg'
authors: ['default']
layout: PostLayout
---

## 前景介绍:

我们知道，随着互联网行业的快速发展，业务与规模与往日不可同日而语。而且当下云容器、微服务等技术也应用广泛，同样给开发带来不小的运维压力，导致我们经常需要面临这些问题：

- 服务链路过长: 随着业务的发展，服务之间的调用关系越来越复杂，导致服务链路过长，难以排查问题。
- 应用监控难: 无法在第一时间得知服务器服务器负载，JVM 占用,GC 次数，接口响应时间等信息。
- 预警速度慢: 当生产环境服务超时，宕机等问题，不能在第一时间得知。
- 日志查询麻烦: 首先要登录服务器，然后通过 cat 命令才能查询到日志，非常麻烦。

那么 SkyWalking 作为应用监控和链路跟踪系统，是如何帮我解决这些问题的呢？

![方案解决](/static/images/skywalking/方案解决.svg)

- Trace 插件: 基于可插拔式架构，提供了丰富的原生 Trac 插件，并且这些插件都实现了 OpenTracing 标准，通过全局 ID 便可以找到整条调用链，每一个端点都可以记录下调用时间长，能在短时间内定位到问题。
- Agent 切面: 利用 JVM 底层 Native 接口，进行系统级的调用，能有效的获取系统监控信息。并且通过 Agent 切面技术，能对各种接口耗时，慢查询进行统计，最后通过 UI 界面进行展示搜索。
- 定时轮询：SkyWalking 通过服务层插件模块化，定义了报警模块，用户可对报警模块进行配置，支持各项指标定时轮询，并且通过 WebHooK 地址发送各种。SkyWalking 不仅是服务层面监控，还能再接口层面和数据库层面进行监控。
- 日志采集：SkyWalking 可以结合 LogBack 等查用的日志组件进行日志上传，并通过 ElasticSeach 进行存储。

SkyWalking 作为一款开源的 APM 系统，它的功能非常强大，支持多语言探针，能帮助我们快速定位问题。

## Skywalking 基础架构:

SkyWalking 的架构设计中:Agent 插件采集数据、GRPC 传输数据、Module 模块接收数据、RocketBot 展示数据。

![架构图](/static/images/skywalking/架构图.svg)

通过上述的架构图我们可以将 SkyWalking 抽层为大致 6 层：

- 应用层：数据源的生产者。
- 探针层：通过探针层进行应用层数据采集。
- 数据传输层：RPC 框架，负责对探针层采集到的数据进行传输。
- 服务层：接收数据传输层的数据，进行功能实现。
- 存储层：利用各种存储组件，为服务层的数据进行持久化。
- 展示层：利用服务层接口，进行 web 界面的数据展示。

### 应用层设计

应用层，可以从容器的角度讲是 Tomcat 容器、JBoy、Jetty 等；从服务包的角度讲，可以是某个 JAR 或者某个 WAR 包。常见的就是一个 SpringBoot 的一个 Web 项目。

**场景举例**:当发送一个 http 请求的时候，会通过 web 容器进入服务，中间可能会经过多层链路，如：ES 存储、MQ 消息队列、MySQL 的查询，最终再返回给调用方。

![应用层](/static/images/skywalking/应用层.svg)

从上图可以看到应用层可能存在的一些问题：

- 请求链路复杂：服务于服务之间调用，服务与组件之间的调用导致服务链路非常复杂。
- 组件的种类繁多：较大的业务中往往会导致项目中组件种类繁多：ELS、MQ、Redis。
- 组件版本不一致：在不同的项目，相同的组件，版本也会存在着不一致。

对应 SkyWalking 来说，就急需要一个组件统一去监控。那么下面的探测器就帮 SkyWalking 解决了这个问题。

### 探针层

探针层是依附于应用层的存在。类型与网络的协议后的 Http 协议和 TCP 协议，没有 TCP 提供的连接、传输、校验等功能，上层的应用协议也将毫无勇武之地。

**探针层的实现**：

- 探针层是通过对 http 请求进行拦截并且进行埋点从而实现获取信息、链路跟踪等功能。
- 它是**无代码侵入**。通过**Agent**技术（不一定是 JavaAgent,也可以是其它语言）。
- 它不是通过代码层**AOP**进行拦截，而是通过 **ByteBuddy** 运行代码生成工具，对**类**进行拦截。
- SkyWalking 提供了丰富的原生插件，或者自定义插件对要拦截的类进行拦截。统称为**增强类**。
- SkyWalking 是可插拔架构，我不需要全量引入所有插件的 Jar,我们只要按需映入进行。
- 服务器信息等基础信息如何采集？SkyWalking 基于 SPI 技术，在项目启动时候会启动各种各样的服务，然后定时调用进行数据采集。

由上可见探针层的 AOP 与 Spring 中 AOP 有所不同，并非之间通过代码形式侵入，而是通过 Agent 技术对应用层进行拦截。是属于虚拟机层面的 AOP。能一定程度上把业务影响降低到最低。这就是 SkyWalking 最大的特点。

![应用层](/static/images/skywalking/探针层.png)
